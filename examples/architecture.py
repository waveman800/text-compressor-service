"""
透明代理模式架构说明

## 工作流程

客户端 → 压缩服务 → 真实模型服务
  ↓         ↓           ↓
发送请求  自动压缩    返回响应
  ↓         ↓           ↓
        转发请求
  ↓         ↓
      返回响应

## 关键优势

1. **客户端零感知**
   - 客户端只需要像调用普通OpenAI API一样
   - 完全不需要知道压缩的存在
   - 只需要改变URL即可

2. **自动化处理**
   - 自动检测上下文是否溢出
   - 自动压缩聊天历史
   - 自动转发到真实模型服务

3. **灵活配置**
   - 通过环境变量配置真实模型服务地址
   - 可以无缝切换不同的模型服务
   - 支持所有OpenAI兼容的API

## 配置说明

在 .env 文件中配置：

```env
# 真实的大模型服务地址
OPENAI_API_BASE_URL=http://localhost:8001/v1

# API密钥（如果需要）
OPENAI_API_KEY=your-api-key
```

## 使用示例

### 客户端代码（完全不需要修改）

```python
import requests

# 只需要把URL改成压缩服务的地址
response = requests.post(
    "http://localhost:8000/v1/chat/completions",  # 压缩服务
    json={
        "model": "gpt-3.5-turbo",
        "messages": chat_history,
        "max_tokens": 256
    }
)

result = response.json()
print(result['choices'][0]['message']['content'])
```

### 内部处理流程（对客户端透明）

1. 压缩服务接收请求
2. 分析聊天历史的token数量
3. 如果超过上下文窗口，自动压缩
4. 构建新的请求（使用压缩后的聊天历史）
5. 转发到真实模型服务
6. 返回模型响应给客户端

## 与其他方案对比

| 方案 | 客户端复杂度 | 服务端侵入性 | 灵活性 |
|------|------------|------------|--------|
| 手动两步调用 | 高（需要处理两次请求） | 无 | 低 |
| 请求报文加标识 | 低 | 高（需要修改模型服务） | 低 |
| 透明代理模式 | 低（只需改URL） | 无 | 高 |

## 性能考虑

压缩服务的额外开销：
- 压缩算法耗时：通常 < 100ms
- 网络转发：通常 < 10ms
- 总额外开销：< 110ms

对于大多数应用场景，这个开销是可以接受的。
如果对性能要求极高，可以考虑：
1. 使用异步处理
2. 批量压缩
3. 缓存压缩结果
"""

# 架构图（ASCII）

ARCHITECTURE = """
┌─────────────┐
│   客户端    │
│  (Client)   │
└──────┬──────┘
       │
       │ 1. 发送OpenAI格式请求
       │    POST /v1/chat/completions
       │    {"messages": [...], ...}
       ↓
┌──────────────────────────────┐
│     压缩服务 (Port 8000)      │
│  ┌────────────────────────┐  │
│  │  1. 接收请求           │  │
│  │  2. 计算token数量      │  │
│  │  3. 判断是否需要压缩   │  │
│  │  4. 执行智能压缩       │  │
│  │  5. 构建代理请求       │  │
│  └───────────┬────────────┘  │
│              │                │
│              │ 6. 转发请求   │
│              ↓                │
│  ┌────────────────────────┐  │
│  │  真实模型服务          │  │
│  │  (Port 8001)           │  │
│  └───────────┬────────────┘  │
│              │                │
│              │ 7. 返回响应    │
│              ↓                │
│  ┌────────────────────────┐  │
│  │  8. 返回响应给客户端   │  │
│  └───────────┬────────────┘  │
└──────────────┼────────────────┘
               │
               │ 9. 返回OpenAI格式响应
               ↓
         ┌──────────┐
         │  客户端   │
         │  收到响应 │
         └──────────┘
"""

print(ARCHITECTURE)
